---
output: 
  pdf_document:
    template: "ms_carpentry/mjk_ms_template.tex"
    fig_caption: yes
  # word_document:
  #   fig_width: 8
  #   fig_height: 7
  #   fig_caption: true
  #   df_print: kable
  #   reference_docx: "ms_carpentry/mjk_ms_template_word.docx"
geometry: margin=1in
header-includes: 
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{setspace}
- \usepackage{mathtools}
- \usepackage[left]{lineno}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{makecell}
- \usepackage{caption}
- \usepackage{textgreek}
- \linenumbers
- \renewcommand\abstractname{\vspace{-1em}}
# - \captionsetup{width=15cm}

bibliography: "ms_carpentry/remote-sensing-resistance.bib"
csl: https://dl.dropboxusercontent.com/s/3xzxni46ldjzqd1/ecology-letters.csl

title: 'Heterogeneity of vegetation structure interacts with fuel moisture to affect forest resistance to wildfire'
author:
  - Michael J Koontz^1,2^
  - Malcolm P North^2,3^
  - Stephen E Fick^4,5^
  - Chhaya M Werner^6^
  - Andrew M Latimer^2^

date:
  "^1^Graduate Group in Ecology, University of California, Davis; Davis, CA  \n
  ^2^Department of Plant Sciences, University of California, Davis; Davis, CA  \n
  ^3^Pacific Southwest Research Station, USDA Forest Service; Mammoth Lakes, CA  \n
  ^4^US Geological Survey, Southwest Biological Science Center; Moab, UT \n
  ^5^Department of Ecology and Evolutionary Biology, University of Colorado, Boulder; Boulder, CO  \n
  ^6^Center for Population Biology, University of California, Davis; Davis, CA"
  
# Author:
# - name: Michael J Koontz
#   affiliation: 1
# - name: Malcolm P North
#   affiliation:
#     - 1
#     - 2
# - name: Stephen E Fick
#   affiliation: 3
# - name: Chhaya M Werner
#   affiliation: 4
# - name: Andrew M Latimer
#   affiliation: 1
# affiliations:
# - name: Graduate Group in Ecology, University of California, Davis, CA 95616 USA
#   code: 1
# - name: USDA Forest Service, Pacific Southwest Research Station, Davis, CA 95618 USA
#   code: 2
# - name: Stockholm Environment Institute, Stockholm 115 23, Sweden
#   code: 3
# - name: Center for Population Biology, University of California, Davis, CA 95616 USA
#   code: 4
# keywords: 
# - resilience
# - wildfire severity
# - RdNBR
# - remote sensing

abstract: "Variation in the size and distribution of trees is thought enable a forest to withstand disturbance and retain its character and function. We test this hypothesis across California's Sierra Nevada region using remotely-sensed data corroborated with on-the-ground measurements.For a given local vegetation density, heterogeneous forests had a greater range of sparse and dense vegetation patches compared to homogenous forests. We find that greater heterogeneity in local forest structure reduces the probability of a high severity wildfire under normal fuel moisture conditions, but increases the probability of high severity fire in extreme fuel moisture conditions. We conclude that, under normal fuel moisture conditions, the effect of the sparse vegetation patches in a heterogeneous forest dominates-- fire spread is interrupted and the probability of a high severity fire is reduced. Under extreme fuel moisture conditions, the effect of the dense vegetation patches in a heterogeneous forest dominates-- those dense patches are more likely to burn at high severity and conditions are ripe for their high severity to be more contagious for nearby vegetation. Heterogeneous forest structure thus makes mixed conifer forest in the Sierra Nevada more resistant to this inevitable disturbance under most fuel moisture conditions, and may increase the probability of its long-term persistence. However, increasing fire activity driven by greater aridity resulting from anthropogenic global change may ultimately lead to more fires burning in extreme fuel moisture conditions in which heterogeneity will increase fire severity."

---
\doublespacing


```{r setup, include=FALSE}
library(here)
library(readr)
library(knitr)
library(kableExtra)
library(captioner)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

fig_nums <- captioner(prefix = "Fig. ")
table_nums <- captioner(prefix = "Tab. ")
eq_nums <- captioner(prefix = "Eq. ")
```

```{r get_references, results = "hide"}
download.file("https://dl.dropboxusercontent.com/s/2ha48iabtlr5jbo/remote-sensing-resistance.bib", here::here("manuscript/ms_carpentry/remote-sensing-resistance.bib"))
```

```{r source_analyses, results = "hide"}
source(here::here("analyses/cbi_summary-stats.R"))
source(here::here("analyses/fire-perims_summary-stats.R"))
source(here::here("analyses/probability-of-high-severity.R"))

ci_betas_1 <- as.data.frame(t(apply(betas_1, MARGIN = 2, FUN = function(x) c(lwr = quantile(x, probs = 0.025), mean = mean(x), upr = quantile(x, probs = 0.975)))))
colnames(ci_betas_1) <- c("lwr", "mean", "upr")
ci_betas_1$param <- row.names(ci_betas_1)
ci_betas_1$radius <- 1

ci_betas_2 <- as.data.frame(t(apply(betas_2, MARGIN = 2, FUN = function(x) c(lwr = quantile(x, probs = 0.025), mean = mean(x), upr = quantile(x, probs = 0.975)))))
colnames(ci_betas_2) <- c("lwr", "mean", "upr")
ci_betas_2$param <- row.names(ci_betas_2)
ci_betas_2$radius <- 2

ci_betas_3 <- as.data.frame(t(apply(betas_3, MARGIN = 2, FUN = function(x) c(lwr = quantile(x, probs = 0.025), mean = mean(x), upr = quantile(x, probs = 0.975)))))
colnames(ci_betas_3) <- c("lwr", "mean", "upr")
ci_betas_3$param <- row.names(ci_betas_3)
ci_betas_3$radius <- 3

ci_betas_4 <- as.data.frame(t(apply(betas_4, MARGIN = 2, FUN = function(x) c(lwr = quantile(x, probs = 0.025), mean = mean(x), upr = quantile(x, probs = 0.975)))))
colnames(ci_betas_4) <- c("lwr", "mean", "upr")
ci_betas_4$param <- row.names(ci_betas_4)
ci_betas_4$radius <- 4

ci_betas <- rbind(ci_betas_1, ci_betas_2, ci_betas_3, ci_betas_4)

cbi_models <- read_csv(here::here("data/data_output/cbi_calibration_model_comparison.csv"))

# This .rds file has the R object name `ss_burned`
load(here::here("data/data_output/burned-fire-samples_texture_configured.rds"))

# What is the mean fm100_s for non-extreme and extreme conditions?
fm100_s_means <- 
  ss_burned %>% 
  as.data.frame() %>% 
  group_by(extreme80_fm100) %>% 
  summarize(mean_fm100 = mean(fm100_s))
```

# Introduction

The ability of heterogeneous systems to absorb disturbances, reorganize, and to persist within a domain of stability with respect to its identity, structure, function, and feedbacks is termed resilience [@Holling1973; @Gunderson2000; @Folke2004; @Walker2004]. Resilience has been demonstrated in complex biological systems characterized by a variety of different types of heterogeneity, including genetic diversity [@Reusch2005; @Baskett2009; @Agashe2009], species diversity [@Tilman1994; @Chesson2000; @Cadotte2013], functional diversity [@Gazol2016], topoclimatic complexity [@Ackerly2010, @Lenoir2013], and temporal environmental variation [@Questad2008]. An emerging paradigm in forest ecology is that spatial heterogeneity in the structure of vegetation on the landscape can confer resilience to disturbances such as wildfire, drought, and insect outbreaks [@Stephens2008; @North2009; @Virah-Sawmy2009]. In California, increasing temperature coupled with increasing drought frequency exacerbate water stress on trees during “hotter droughts” [@ParkWilliams2012; @Millar2015]. Further, a century of fire suppression policy has led to drastic densification and homogenization of forest structure in the Sierra Nevada [@North2015]. Wildfire regimes have changed in these forests such that fires are bigger, more frequent, and burn at higher severity [@Miller2007; @Cansler2014; @Harvey2016c]. Changes in wildfire disturbance regimes are particularly suited to catalyze catastrophic shifts in ecosystems because of their feedback with spatial forest heterogeneity at multiple scales. Thus, western North American forests are experiencing novel, “unhealthy” conditions (*sensu* @Raffa2009) that are liable to upset the feedbacks between forest structure and pattern-forming ecological disturbances that historically stabilized the system and made it resilient [@Raffa2008; @Millar2015]. Forests are of high management priority [@Hansen2013; @Crowther2015; @Millar2015; @Trumbore2015], thus it is critical to understand the mechanisms underlying the effect of spatial heterogeneity in forest structure on forest resilience. In order to unite resilience theory with empirical observations, it is imperative to move from metaphors to measurements. 

Resilience in forest systems is fundamentally challenging to quantify because forests are comprised of long-lived species, span large geographic extents, and are affected by disturbances at a very broad range of spatial scales. A key feature of resilience is resistance-- how easy it is to change the system state [@Walker2004]. In mixed conifer forests of California's Sierra Nevada mountain range, wildfire disturbance is most frequently associated with landscape-scale changes in system state
<!-- Can you use a more specific term than system state here? Biomass? structure? -->.
 <!-- I would not define severity here, but stick with the next paragraph --> Thus, a resistant forest system should generally experience lower tree mortality when a fire inevitably occurs.

Severity describes the effect of a wildfire on an ecosystem-- often the amount of vegetation mortality [@Sugihara2006]. Wildfire severity can be measured by comparing pre- and post-fire satellite imagery for a specific area, but this usually requires considerable manual effort for image collation and processing, followed by calibration with field data [@Miller2007; @Miller2009a; @DeSantis2010; @Cansler2012; @Veraverbeke2013; @Parks2014; @Prichard2014; @Edwards2018; @Fernandez2018]. Efforts to measure severity across broad spatial extents, such as the Monitoring Trends in Burn Severity project [@Eidenshink2007], are unsuitably subjective for rigourous scientific analysis though they serve their intended management purpose admirably [@Kolden2015]. Automated efforts to remotely assess wildfire impacts have arisen, but they tend to focus on more aggregate measures of wildfire such as whether an area burned or the probability that it burned rather than the severity of the burn (@Bastarrika2011; @Goodwin2014; @Boschetti2015; @Hawbaker2017 but see @Reilly2017). Here, we present a method to automate the measurement of wildfire severity using minimal user inputs: a geometry of interest (a wildfire perimeter or a field plot location) and an alarm date (the date the fire began). This information is readily available in many fire-prone areas (such as California, via the Fire and Resource Assessment Program; http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index) or could potentially be derived using existing products (such as the Landsat Burned Area Essential Climate Variable product described in @Hawbaker2017). Further, the flexibility of this approach faciliates collaborative calibration with field-collected wildfire severity data. 

Vegetation characteristics such as canopy density [@Rouse1973; @Young2017], moisture content [@Asner2015], insect attack [@Nasi2015], and even functional diversity [@Asner2017] can be measured using remotely-sensed imagery. Texture analysis of imagery can quantify ecologically relevant environmental heterogeneity across broad spatial scales [@Wood2012]. Texture analysis was originally developed for image classification and computer vision, and it characterizes each pixel in an image by a summary of its neighboring pixels [@Haralick1973; @Conners1984]. Ecologists have successfully used texture measurements to augment predictions of species richness (@Huang2014; @Stein2014a; @Tuanmu2015 but see @Culbert2012). 

### Creation and maintenance of spatial heterogeneity

Forest structure is defined by the size and distribution of trees on the landscape. Differences in tree crown heights characterize vertical structure, while differences in the rooting locations of trees characterizes horizontal structure [@North2009]. Competition for light, water, and other resources can yield aggregations of trees within favorable microsites or more widely spaced trees to ameliorate detrimental interactions [@Clyatt2016]. Demographic processes of dispersal, recruitment, and mortality affect forest structure by adding or subtracting whole trees. Reciprocally, the forest structure can also influence these pattern-forming processes such as when vegetation overstory alters microclimate or changes tree demographic rates [@Larson2012; @DeFrenne2013; @Ford2013]. The stabilizing effects of these reciprocal processes in forests are hallmarks of a resilient system [@Folke2004]. In the Sierra Nevada range of California, one of the strongest feedbacks between forest structure and pattern-generating ecological processes is wildfire, which affects hundreds of thousands to millions of hectares of forested area per year in the Sierra Nevada [@Larson2012; @ParkWilliams2012; @Millar2015]. 

Wildfire interacts dynamically with forest structure [@Westerling2006; @ParkWilliams2012; @Larson2012]. Wildfire can affect the future forest structure by changing demographic rates of individual trees (e.g. increasing growth or germination via increasing light or nitrogen availability), but it’s most lasting impact to forest structure is in the pattern of killed trees left in its wake [@Larson2012]. Wildfire behavior is inherently complex and is influenced by local weather, topography, and heterogeneous fuel conditions created by departures from the average fire return interval at any particular place [@Sugihara2006; @Collins2010]. For instance, high tree density and presence of “ladder fuels” in the understory increase the probability of crown fire that kills a high proportion of trees [@Stephens2008; @North2009]. A heterogeneous forest can largely avoid overstory tree mortality because a reduced amount of accumulated ladder fuel decreases its ability to get into the crown (where mortality is more likely to result), because wide spacing between tree clumps interrupts high severity fire spread across the landscape, and because tree clumps with fewer trees don’t facilitate self-propagating fire behavior [@Graham2004; @Scholl2010]. In forests with relatively intact fire regimes and heterogeneous stand conditions such as in the Jeffrey pine forests of the Sierra San Pedro Martir in Baja, California, there tends to be reduced vegetation mortality after wildfires compared to fire-suppressed forests [@Stephens2008]. Thus, forest heterogeneity is predicted to persist due to resistance to inevitable wildfire disturbance [@Graham2004; @Moritz2005; @Stephens2008]. However, it is unclear at what scale heterogeneity in forest structure is meaningful for resilience [@Kotliar1990]. 

We use a new remote sensing approach to calculate wildfire severity across broad spatial extents as well as image texture analysis to ask: does spatial variability in forest structure make California mixed conifer forests more resilient by reducing the severity of wildfires when they occur? Further, we ask whether this process is dependent upon topographic, fire weather, or other fuel conditions.

# Methods

This work occurred in two phases. First, we developed a new approach to calculating wildfire severity across broad spatial and temporal scales and calibrated our measurements to those from the field. We applied this approach to all known fire perimeters in the Sierra Nevada region between 1984 and 2016 as defined by the Fire and Resource Assessment Program (FRAP, http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index), which is the most comprehensive digital record of fire occurrence in California. Second, we used texture analysis of remotely-sensed imagery bounded by the perimeters in the FRAP database to develop a measure of vegetation heterogeneity and modeled how that heterogeneity affected wildfire severity, accounting for other key drivers of wildfire behavior. 


```{r, results = "hide"}
fig_nums(name = "fig-study-geographic-setting")
```

![Geographic setting of the study. A) Burned areas of yellow pine/mixed conifer forest between 1984 and 2016 in Sierra Nevada mountain range of California according to the State of California Fire Resource and Assessment Program database, the most comprehensive database of fire perimeters of its kind (data available for download from http://frap.fire.ca.gov/data/frapgisdata-sw-fireperimeters_download). Image represents a rasterized version of polygons from the FRAP database at a 100m x 100m pixel resolution. Colors indicate how many fire perimeters overlapped a given pixel within the study time period. 
<!-- color scale is too dark -- hard to distinguish most burns -->
B) Location of yellow pine/mixed conifer forests as designated by the Fire Return Interval Departure (FRID) product which describes the potential vegetation in an area based on the pre-EuroAmerican colonization fire regime. (Data are available for download from https://www.fs.usda.gov/detail/r5/landmanagement/gis/?cid=STELPRDB5327836). Image represents a rasterized version of polygons from the FRID database at a 100m x 100m pixel resolution. C) Locations of random samples drawn from fires depicted in panel A that were in yellow pine/mixed conifer forest as depicted in panel B, and which were designated as "burned" by exceeding a threshold relative burn ratio (RBR) determined by calibrating the algorithm presented in this study with ground based composite burn index (CBI) measurements.](../figures/study-geographic-setting.pdf)


## Study area

Our study assesses the effect of vegetation structure on wildfire severity in the Sierra Nevada mountain range of California in yellow pine/mixed conifer forests between 1984 and 2016 (`r fig_nums(name = "fig-study-geographic-setting", display = "cite")`). Forests in our study area are dominated by a mixture of conifer species including ponderosa pine (*Pinus ponderosa*), sugar pine (*Pinus lambertiana*), incense-cedar (*Calocedrus decurrens*), Douglas-fir (*Pseudotsuga menziesii*), white fir (*Abies concolor*), and red fir (*Abies magnifica*) [@Stephens2004; @Collins2015]. Tree density in the early 20th century was relatively low, with about 25-79 trees/ha and about 8-30 m2/ha of live basal area [@Collins2015]. Since this time, canopy cover has increased by 25-49%, overall tree density has increased by >75%, and white fir (*Abies concolor*) makes up a greater percentage of basal area compared to forests in the early 20th century [@Stephens2015]. The change in tree density is underlaid by a shift in size distribution: modern mixed conifer forests have 2.5 times as many trees between 30.4 and 61.0cm diameter at breast height (dbh) per hectare (103.9 versus 41.0 trees/ha) and half as many trees greater than 91.4cm dbh per hectare (8.7 versus 16.7 trees/ha) compared to forests in 1911 [@Stephens2015].

Mixed conifer forests in the Sierra Nevada burned every 11 years on average for several centuries prior to Euro-American settlement [@Steel2015]. These relatively frequent burns prevented the accumulation of fuel on the ground, and limited the intensity of the next fire. This average fire return interval is short compared to the regeneration time of the dominant species, so the fire regime of Sierra Nevada mixed conifer forests in this period is usually classified as a “high frequency/low-mid severity” [@Steel2015]. 

## A new approach to remotely sensing wildfire severity

Wildfire severity can be reliably detected remotely by comparing pre- and postfire imagery from sensors aboard the Landsat series of satellites [@Eidenshink2007; @Miller2007]. The Thematic Mapper (TM; Landsat 4 and 5), Enhanced Thematic Mapper Plus (ETM+; Landsat 7), and Operational Land Imager (OLI; Landsat 8) sensors generate compatible top-of-atmosphere (TOA) spectral reflectance data suitable for scientific analysis. Recent advances in radiometric correction post-processing can compensate for various atmospheric distortions and generate more accurate measurements of surface reflectance in narrow wavelength bands spanning the electromagnetic spectrum [@Masek2006; @Vermote2016; @USGSledaps2017; @USGSlasrc2017]. Landsat satellites image the entire Earth approximately every 16-days and repeat images of the same area are geometrically coregistered such that overlapping pixels correspond to the same area on the ground. We used Google Earth Engine, a cloud-based geographic information system and image hosting platform, for all image collation and processing in order to leverage the centralized availability of the latest processed satellite images and integrated image processing tools for broad-scale analyses [@Gorelick2017].

<!-- not sure this next paragraph is necessary, if looking for cuts -->
The base assumption of our new approach to calculating wildfire severity is that each fire's geographic data and associated attributes are represented by a self-contained "feature". Many fire datasets (e.g., FRAP, USFS Region 5 Fire Perimeter Data, CBI field plot locations from @Zhu2006 and @Sikkink2013) already meet this criteria. In order to achieve a programmatic, automatic assessment of wildfire severity, severity-calculating algorithms must be able to use only the information within each feature. Time efficiencies and data compatibility benefits are attained when those algorithms are applied across an entire feature collection, performing their operation on each feature in turn. At a minimum, our algorithm requires that each feature contain some geographic information (e.g., a fire perimeter or a CBI plot location) and a fire start date (i.e., an "alarm date").

### Fetching and processing pre- and postfire imagery


```{r, results = "hide"}
fig_nums(name = "fig-image-acquisition-algorithm")
```

All Landsat imagery was fetched by "scene"-- the atomic unit of image data in the Landsat collection representing an area on the Earth's surface approximately 170 km long by 183 km wide. For each feature, a collection of Landsat scenes was fetched both before and after the fire by defining a date range to search for imagery. The date range for prefire imagery started one day before each feature's alarm date and extended backward in time by a user-defined time window. The date range for postfire imagery was exactly one year after the date range for the prefire search (i.e., one year after the day before the fire, extending backward in time by the same time window). We tested 4 time windows: 16, 32, 48, or 64 days which were chosen to ensure that at least 1, 2, 3, or 4 Landsat images, taken on a 16-day interval, were captured by the date ranges (`r fig_nums(name = "fig-image-acquisition-algorithm", display = "cite")`).

![Schematic for how Landsat imagery was assembled in order to make comparisons between pre- and post-fire conditions. This schematic depicts a 64-day window of image collation prior to the fire which comprise the pre-fire image collection. A similar, 2-month window collection of imagery is assembled one year after the pre-fire image collection.](../figures/image-acquisition-algorithm.pdf)

The Landsat archive was filtered to generate a prefire image collection comprising only the Landsat scenes depicting some part of the feature geometry and within the prefire date range. A postfire image collection was similarly generated by filtering the Landsat archive by the postfire date range and the feature geometry. The Landsat archive we filtered included imagery from Landsat 4, 5, 7, and 8, so each pre- and postfire image collection may contain a mix of scenes from different satellite sources to enhance coverage.

```{r eq_ndvi, results = "hide"}
eq_nums(name = "eq-ndvi")
```

```{r eq_ndmi, results = "hide"}
eq_nums(name = "eq-ndmi")
```

```{r eq_nbr, results = "hide"}
eq_nums(name = "eq-nbr")
```

```{r eq_nbr2, results = "hide"}
eq_nums(name = "eq-nbr2")
```

For each image in the pre- and postfire image collections, we masked pixels that were not clear (i.e., clouds, cloud shadows, snow, and water) and calculated standard indices that capture vegetation cover and fire effects such as charring: normalized difference vegetation index (NDVI; `r eq_nums(name = "eq-ndvi", display = "cite")`; @Rouse1973), normalized difference moisture index (NDMI; `r eq_nums(name = "eq-ndmi", display = "cite")`; @Gao1996), normalized burn ratio (NBR; `r eq_nums(name = "eq-nbr", display = "cite")`; @Key2006; @USGSlasrc2017; @USGSledaps2017), and normalized burn ratio version 2 (NBR2; `r eq_nums(name = "eq-nbr2", display = "cite")`; @USGSlasrc2017; @USGSledaps2017; @Hawbaker2017).

(@eq-ndvi) $\label{eq-ndvi}
ndvi = \mathopen(nir - red\mathclose) / \mathopen(nir + red\mathclose)$

(@eq-ndmi) $\label{eq-ndmi}
ndmi = \mathopen(nir - swir1\mathclose) / \mathopen(nir + swir1\mathclose)$

(@eq-nbr) $\label{eq-nbr}
nbr = \mathopen(nir - swir2\mathclose) / \mathopen(nir + swir2\mathclose)$

(@eq-nbr2) $\label{eq-nbr2}
nbr2 = \mathopen(swir1 - swir2\mathclose) / \mathopen(swir1 + swir2\mathclose)$

Where $nir$ is the near infrared band (band 4 on Landsat 4, 5, and 7; band 5 on Landsat 8) and $red$ is the red band (band 3 on Landsat 4, 5, and 7; band 4 on Landsat 8), $swir1$ is the first short wave infrared band (band 5 on Landsat 4, 5, and 7; band 4 on Landsat 8), $swir2$ is the second short wave infrared band (band 7 on Landsat 4, 5, 7, and 8)

We summarized each prefire image collection into a single prefire image using a median reducer, which calculated the median of the unmasked values on a per-pixel basis across the stack of images in the prefire collection. We similarly summarized the postfire image collection into a single postfire image.

### Calculating wildfire severity

```{r eq_dindex, results = "hide"}
eq_nums(name = "eq-dindex")
```

We calculated remotely-sensed wildfire severity using the relative burn ratio (RBR) [@Parks2014], the delta normalized burn ratio (dNBR) [@Eidenshink2007; @Miller2007], the relative delta normalized burn ratio (RdNBR) [@Miller2007], the delta normalized burn ratio 2 (dNBR2) [@Hawbaker2017], the relative delta normalized burn ratio 2 (RdNBR2), and the delta normalized difference vegetation index (dNDVI) [@Eidenshink2007]. Following the success of the RdNBR metric in other studies, we also calculate an analogous metric using NDVI-- the relative delta normalized difference vegetation index (RdNDVI).

We calculated the delta severity indices (dNBR, dNBR2, dNDVI) by subracting the respective postfire indices from the prefire indices (NBR, NBR2, and NDVI) without multiplying by a rescaling constant (e.g., we did not multiply the result by 1000 as in @Miller2007; `r eq_nums("eq-dindex", display = "cite")`). Following @Reilly2017, we chose not to correct the delta indices using a phenological offset value (typically calculated as the delta index in homogenous forest patch outside of the fire perimeter), as our approach implicitly accounts for phenology by incorporating multiple cloud-free images across the same time window both before the fire and one year later.

(@eq-dindex) $\label{eq-dindex}
dI = I_{\text{prefire}} - I_{\text{postfire}}$

```{r eq_rdindex, results = "hide"}
eq_nums(name = "eq-rdindex")
```

We calculated the relative delta severity indices, RdNBR and RdNDVI, by scaling the respective delta indices (dNBR and dNDVI) from `r eq_nums(name = "eq-rdindex", display = "cite")` by a square root transformation of the absolute value of the prefire index:

(@eq-rdindex) $\label{eq-rdindex}
RdI = \frac{dI}{\sqrt{\mathopen|I_{\text{prefire}}\mathclose|}}$


```{r eq_rbr, results = "hide"}
eq_nums(name = "eq-rbr")
```

We calculated the relative burn ratio (RBR) following @Parks2014 using `r eq_nums(name = "eq-rbr", display = "cite")`:

(@eq-rbr) $\label{eq-rbr}
RBR = \frac{dNBR}{NBR_{\text{prefire}} + 1.001}$


```{r, results = "hide"}
fig_nums(name = "fig-pre-post-rbr")
```

Example algorithm outputs are shown in `r fig_nums(name = "fig-pre-post-rbr", display = "cite")`.

![Example algorithm outputs for the Hamm Fire of 1987 (top row) and the American Fire of 2013 (bottom row) showing: prefire true color image (left column), postfire true color image (center column), relative burn ratio (RBR) calculation using a 48-day image collation window before the fire and one year later. For visualization purposes, these algorithm outputs have been resampled to a resolution of 100m x 100m from their original resolution of 30m x 30m. Data used for analyses were sampled from the outputs at the original resolution.](../figures/pre-post-rbr.pdf)

### Calibrating remotely-sensed wildfire severity with field-measured wildfire severity

```{r, results = "hide"}
fig_nums(name = "fig-cbi-extent")
```

![Location of CBI plots in the Sierra Nevada mountain range of California \label{fig-cbi-extent}](../figures/cbi-extent.pdf)

We calibrated our remotely-sensed measure of wildfire severity with `r total_conifer_plots` field measures of overstory tree mortality from two previously published studies [@Zhu2006; @Sikkink2013] (`r fig_nums(name = "fig-cbi-extent", display = "cite")`). The Composite Burn Index (CBI) is a metric of change in vegetation across several vertical strata [@Key2006] and has a long history of use in calibrating remotely-sensed severity data [@Miller2007; @Miller2009a; @Cansler2012; @Parks2014; @Prichard2014]. Following @Miller2007, @Miller2009a, and @Parks2014, we fit a non-linear model to each remotely-sensed severity metric of the following form:

```{r eq-cbi-calibration, results = "hide"}
eq_nums(name = "eq-cbi-calibration")
```

(@eq-cbi-calibration) $\label{eq-cbi-calibration}
\text{remote\_severity} = \beta_0 + \beta_1 e^{\beta_2 \text{cbi\_overstory}}$

<!-- My sense is that the scope of 'training' data used for creating the severity index is a limitation that might need to be addressed, if we are to propose that this is a new method for determining severity (this subject is almost another paper in itself). For instance, how representative are the fires used to fit this relationship? I would predict the 'best' severity indicator might vary by geography/forest. I wonder if it would be possible to 'map' the CBI fires against all fires analyzed in PCA space, using relevant environmental factors (climate conditions, forest metrics, etc). Alternatively we could just say that we chose RBR based on its correspondence with field data and not quibble about the best severity indicator -->
We fit the model in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` for all 7 of our remotely-sensed severity metrics (RBR, dNBR, RdNBR, dNBR2, RdNBR2, dNDVI, RdNDVI) using 4 different time windows from which to collate satellite imagery (16, 32, 48, and 64 days). Following @Cansler2012 and @Parks2014, we used interpolation to extract remotely-sensed severity at the locations of the CBI field plots to better align remote and field measures of severity. We extracted remotely-sensed severity values using both bilinear interpolation, which returns a severity value weighted by the 9 pixel values nearest to the CBI plot location, and bicubic interpolation, which returns a severity value weighted by the 16 pixel values nearest to the CBI plot location. In total, we fit 56 models (7 severity measures, 4 time windows, 2 interpolation methods) and performed five-fold cross validation using the `modelr` and `purrr` packages. To compare goodness of model fits with @Miller2007, @Miller2009a, and @Parks2014, we report the average R^2^ value from the five folds for each of the 56 models but note that R^2^ for non-linear regressions do not have the same interpretation that they do for linear regression (i.e., R^2^ can be greater than 1 for non-linear regression, so it can't be interpreted as the proportion of variation explained by the model). We used the Relative Burn Ratio (RBR) calculated using bicubic interpolation within a 48-day window as our response variable for analyses of vegetation heterogeneity, as it showed the best correspondence to field severity data measured as average R^2^ across the five folds.


## Remote sensing other conditions

### Heterogeneity of vegetation

```{r, results = "hide"}
fig_nums(name = "fig-heterogeneity-raster")
```

We used texture analysis to calculate a first order, remotely-sensed measure of forest heterogeneity [@Haralick1973; @Tuanmu2015]. Within a moving square neighborhood window with sides of 90m, 150m, 210m, and 270m (corresponding to a moving neighborhood window of $`r round(90^2 / 10000, 2)`$ ha, $`r round(150^2 / 10000, 2)`$ ha, $`r round(210^2 / 10000, 2)`$ ha, and $`r round(270^2 / 10000, 2)`$ ha), we calculated heterogeneity for each pixel as the standard deviation of the NDVI values of its neighbors (not including itself) (See `r fig_nums(name = "fig-heterogeneity-raster", display = "cite")`).

![Example of homogenous forest (top row) and heterogenous forest (bottom row) with the same mean NDVI values (~0.6). Each column represents heterogeneity measured using a different neighborhood size. \label{fig-heterogeneity-raster}](../figures/heterogeneity-demo-raster.pdf)

### Topographic conditions

Elevation data were sourced from the Shuttle Radar Topography Mission [@Farr2007], a 1-arc second digital elevation model. Slope and aspect were extracted from the digital elevation model. Per-pixel topographic roughness was calculated as the standard deviation of elevation values within a the same kernel sizes as those used for vegetation heterogeneity (approximately 90m, 150m, 210m, and 270m on a side and not including the central pixel). Some work has shown that terrain ruggedness [@Holden2009], and particularly coarser-scale terrain ruggedness [@Dillon2011], is an important predictor of wildfire severity.

```{r eq-potential-annual-heat-load, results = "hide"}
eq_nums(name = "eq-potential-annual-heat-load")
```

We used the digital elevation model to calculate the potential annual heat load (`r eq_nums(name = "eq-potential-annual-heat-load", display = "cite")` at each pixel, which is an integrated measure of latitude, slope, and a folding transformation of aspect about the northeast-southwest line, such that northeast becomes 0 radians and southwest becomes $\pi$ radians (@McCune2002 with correction in @McCune2007):

(@eq-potential-annual-heat-load) $\begin{aligned}
\label{eq-potential-annual-heat-load}
aspect_{folded} &= \mathopen| \pi - \mathopen| aspect - \frac{5\pi}{4}\mathclose| \mathclose| \\
log(pahl) &= \begin{aligned}
&-1.467 + \\
&1.582 * cos(latitude) cos(slope) - \\
&1.5 * cos(aspect_{folded}) sin(slope) sin(latitude) - \\
&0.262 * sin(lat) sin(slope) + \\
&0.607 * sin(aspect_{folded}) sin(slope) \\
\end{aligned}
\end{aligned}$

Where $pahl$ is the potential annual heat load, $aspect_{folded}$ is a transformation of aspect in radians, and both $latitude$ and $slope$ are extracted from a digital elevation model with units of radians.

### Fire weather conditions

The 100-hour fuel moisture data were sourced from the Gridmet product [@Abatzoglou2013a] and were calculated as the median 100-hour fuel moisture for the 3 days prior to the fire. We included a boolean variable for extreme values of 100-hour fuel moisture if they were lower than 7.7%, since these values fall below the 20^th^ percentile of 100-hour fuel moisture for the Sierra Nevada region [@Stephens2013a].

## Modeling the effect of heterogeneity on severity

<!-- how was the 'extreme' threshold determined? -->

We scaled all continuous predictor variables (keeping the boolean variable representing whether the fire weather was extreme or not unscaled), and treated each individual fire as having a random intercept effect using the mixed effects logistic regression model described in `r eq_nums(name = "eq-severity-model", display = "cite")`.

(@eq-severity-model) $\begin{aligned}
\label{eq-severity-model}
severity_{i, j} &\sim Bern(\phi_{i,j}) \\
logit(\phi_{i,j}) &= 
\begin{aligned}
& \beta_0 + \\
& \beta_{\text{heterogeneity}} * \text{heterogeneity}_i + \\
& \beta_{\text{extreme\_fm100}} * \text{extreme\_fm100}_i + \\
& \beta_{\text{fm100}} * \text{fm100}_i + \\
& \beta_{\text{prefire\_ndvi}} * \text{prefire\_ndvi}_i + \\
& \beta_{\text{topographic\_roughness}} * \text{topographic\_roughness}_i + \\
& \beta_{\text{pahl}} * \text{pahl}_i + \\
& \beta_{\text{heterogeneity*extreme\_fm100}} * \text{heterogeneity}_i * \text{extreme\_fm100}_i + \\ 
& \beta_{\text{heterogeneity*fm100}} * \text{heterogeneity}_i * \text{fm100}_i + \\ 
& \beta_{\text{extreme\_fm100*fm100}} * \text{extreme\_fm100}_i * \text{fm100}_i + \\ 
& \beta_{\text{heterogeneity*extreme\_fm100*fm100}} * \text{heterogeneity}_i * \text{extreme\_fm100}_i * \text{fm100}_i + \\ 
& \gamma_j
\end{aligned}
\\
\gamma_j &\sim \mathcal{N}(0, \sigma_{\text{fire}})
\end{aligned}$


Each neighborhood size (90x90m, 150x150m, 210x210m, and 270x270m) was substituted in turn for the heterogeneity of NDVI, neighborhood mean NDVI, and terrain ruggedness covariates to generate a candidate set of 4 models.

To assess the effect of heterogeneity of forest structure on the probability of a high-severity wildfire, we contrasted two different combinations of the $\beta$ coefficients: 1) a combination that corresponded to the effect of a one standard deviation increase in heterogeneity for a forested area in non-extreme fuel moisture conditions ($\text{extreme\_fm100} =$ 0) with an average prefire NDVI (scaled $\text{prefire\_ndvi} =$ 0), potential annual heat load (scaled $\text{pahl} =$ 0), and topographic roughness (scaled $\text{topographic\_roughness} =$ 0), as well as an average 100-hour fuel moisture for non-extreme fuel moisture conditions (scaled $\text{fm100} =$ 0.888), and 2) a combination that corresponded to the effect of a one standard deviation increase in heterogeneity for a forested area in extreme fuel moisture conditions ($\text{extreme\_fm100} =$ 1) with an average prefire NDVI (scaled $\text{prefire\_ndvi} =$ 0), potential annual heat load (scaled $\text{pahl} =$ 0), and topographic roughness (scaled $\text{topographic\_roughness} =$ 0), as well as an average 100-hour fuel moisture for extreme fuel moisture conditions (scaled $\text{fm100} =$ -0.588).

## Statistical software and data availability

We used `R` for all statistical analyses [@RCoreTeam2018]. We used the `brms` package to fit mixed effects models [@Burkner2017]. We used a No U-Turn Sampler (NUTS) with 4 chains and 2000 samples per chain. Chain convergence was assessed for each estimated parameter by ensuring Rhat values were less than or equal to 1.01.

Data are available via the Open Science Framework.

# Results

```{r cbi_models_pretty_print}
print_cbi_models <- cbi_models
print_cbi_models[, 5:13] <- round(cbi_models[, 5:13], 3)
print_cbi_models <-
  print_cbi_models %>%
  arrange(desc(r2_kfold)) %>% 
  mutate(rank = 1:nrow(.)) %>% 
  dplyr::select(rank, response, time_window, interpolation, r2_kfold, a, b, c, low_sev, mod_sev, hi_sev)
```

## A new approach to remotely sensing wildfire severity


```{r, results = "hide"}
fig_nums(name = "fig-cbi-calibration")
```

![Calibration of three remotely-sensed severity metrics using new automated image collation algorithm to `r total_conifer_plots` field measures of severity.](../figures/remote-sensed-severity-calibration.pdf)

We found that the remotely sensed relative burn ratio (RBR) metric of wildfire severity measured across a 48 day interval prior to the wildfire alarm date correlated best with ground based composite burn index (CBI) measurements of severity (5-fold cross validation $R^2 =$ `r print_cbi_models$r2_kfold[1]`; `r table_nums(name = "table-cbi-models", display = "cite")`). Our method to calculate remotely sensed severity using automated Landsat image fetching performs as well or better than most other reported methods that use hand-curation of Landsat imagery [@Edwards2018]. Further, several combinations of remotely sensed severity metrics, time windows, and interpolation methods were well-validated by ground based severity metrics, including those based on NDVI which is calculated using reflectance in shorter wavelengths than those typically used for measuring severity (`r table_nums(name = "table-cbi-models", display = "cite")`). The top three models are depicted in `r fig_nums(name = "fig-cbi-calibration", display = "cite")`.

```{r, results = "hide"}
table_nums(name = "table-cbi-models")
```

```{r cbi_models_table}
knitr::kable(print_cbi_models,
             # format = "latex",
             longtable = TRUE,
             booktabs = TRUE,
             caption = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with ground based composite burn index (CBI) severity sorted in descending order by the $R^2$ value from a 5-fold cross validation. A total of 56 models were tested representing all possible combinations of 7 different measures of wildfire severity (RBR, dNBR, dNBR2, RdNBR, RdNBR2, dNDVI, and RdNDVI), 4 different time windows in which Landsat imagery was acquired and summarized with a median reducer on a pixel-by-pixel basis (16 days, 32 days, 48 days, and 64 days), and two different interpolation methods (bilinear and bicubic). The three parameters (\\textbeta\\textsubscript{0}, \\textbeta\\textsubscript{1}, and \\textbeta\\textsubscript{2}) from the nonlinear model fit described in Eq. \\ref{eq-cbi-calibration} are reported. For each model, the value of the remotely sensed wildfire severity measurement corresponding to the lower bounds of 3 commonly used categories of severity are reported ('low' corresponds to a CBI value of 0.1, 'mod' corresponds to a CBI value of 1.25, and 'high' corresponds to a CBI value of 2.25)",
             caption.short = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with CBI severity",
             escape = FALSE,
             col.names = c("Rank", "\\makecell[c]{Severity\\\\measure}", "\\makecell[c]{Time\\\\window}", "Interpolation", "\\makecell[c]{k-fold\\\\$R^2$}", "\\makecell[c]{\\textbeta\\textsubscript{0}}", "\\makecell[c]{\\textbeta\\textsubscript{1}}", "\\makecell[c]{\\textbeta\\textsubscript{2}}", "low", "mod", "high")) %>%
  kable_styling(latex_options = c("repeat_header"))
```

Based on these model comparisons, we used the relative burn ratio (RBR) calculated using a 48-day time window before the fire and bicubic interpolation as our metric of severity. We created the boolean response variable representing whether the sampled point burned at high severity or not by determining whether the RBR exceeded `r print_cbi_models$hi_sev[1]`, the threshold for high severity derived using the non-linear relationship in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` (`r table_nums(name = "table-cbi-models", display = "cite")`). 

## Prefire vegetation density, annual heat load, and topographic roughness effects on wildfire severity

```{r, results = "hide"}
fig_nums(name = "fig-effect-sizes")
```

![Half eye plots depicting the effect sizes for parameters of interest. Each column represents model results using a different neighborhood window size. Dot-whiskers along the x dimension represent mean and 95% credible intervals (using a symmetric quantile method) of each parameter of interest. The half eyes represent the posterior distributions of the parameters of interest. To depict interactions with whether the pixel burned under normal conditions (20th percentile or greater 100 hour fuel moisture) or extreme conditions (less than 20th percentile 100 hour fuel moisture), we show separate dot-whiskers and half eyes for the parameters that interact with the boolean "extreme conditions or not" variable. Blue lines represent parameter estimates under normal 100 hour fuel moisture conditions and red lines represent parameter estimates under extreme 100 hour fuel moisture conditions. For the effect of heterogeneity, the parameter estimates depicted represent the effect at the average fuel moisture value (on a standardized scale) in each condition. Thus, while other variables (e.g., potential annual heat load) are 0 in the calculation of the heterogeneity effect sizes to reflect the effect of heterogeneity at average values of those variables, the 100 hour fuel moisture variable is set to greater than 0 for normal conditions (to reflect that the average fuel moisture in normal conditions is higher than the overall average) and less than 0 for extreme conditions (to reflect that the average fuel moisture in extreme conditions is lower than the overall average).](../figures/prob-hi-sev_all-effect-sizes.pdf)

We found that the strongest influence on the probability of a forested area burning at high severity is the density of the vegetation, as measured by the prefire NDVI ($\beta_{\text{prefire\_ndvi}}=$ `r paste0(round(ci_betas[ci_betas$param == "b_preFire_ndvi", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_preFire_ndvi", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))` on the log-odds scale; `r fig_nums(name = "fig-effect-sizes", display = "cite")`). For all 4 models using different neighborhood sizes for the heterogeneity and topographic roughness predictors, a greater prefire NDVI led to a greater probability of high severity fire. Potential annual heat load, which integrates aspect, slope, and latitude, also had a strong positive relationship with the probability of a high severity fire ($\beta_{\text{pahl}}=$ `r paste0(round(ci_betas[ci_betas$param == "b_pahl", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_pahl", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`; `r fig_nums(name = "fig-effect-sizes", display = "cite")`). Areas that were located on southwest facing slopes at lower latitudes tended to be more likely to burn at high severity. We found no effect of local topographic roughness on wildfire severity at any neighborhood size ($\beta_{\text{topographic\_roughness}}=$ `r paste0(round(ci_betas[ci_betas$param == "b_topo_roughness", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_topo_roughness", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`; `r fig_nums(name = "fig-effect-sizes", display = "cite")`).

### 100 hour fuel moisture effect on wildfire severity

We found a non-linear effect of 100 hour fuel moisture on wildfire severity such that, under normal fuel moisture conditions (100 hour fuel moisture greater than 20^th^ percentile), increasing fuel moisture had a strong negative effect of the probability of a high severity wildfire ($\beta_{\text{fm100}}=$ `r paste0(round(ci_betas[ci_betas$param == "b_fm100_normal", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_fm100_normal", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`; `r fig_nums(name = "fig-effect-sizes", display = "cite")`). However, under extreme fuel moisture conditions (100 hour fuel moisture less than 20^th^ percentile), we detected no influence of fuel moisture on the probability of a high severity wildfire ($\beta_{\text{fm100}}+\beta_{\text{extreme\_fm100}}+\beta_{\text{extreme\_fm100*fm100}}=$ `r paste0(round(ci_betas[ci_betas$param == "b_fm100_xtreme", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_fm100_xtreme", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`; `r fig_nums(name = "fig-effect-sizes", display = "cite")`).

### Heterogeneity in vegetation structure effect on wildfire severity

We found strong evidence for an effect of heterogeneity of vegetation structure on the probability of a high severity wildfire. The effect was modulated by the fuel moisture conditions. Under normal fuel moisture conditions, an increasing heterogeneity of vegetation structure greatly reduced the probability of a high severity wildfire accounting for other variables (
$\beta_{\text{heterogeneity}}+$ 
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 0), mean_fm100)), 3)` 
$*\beta_{\text{fm100}}+$ 
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 0), mean_fm100)), 3)` 
$*\beta_{\text{heterogeneity*fm100}}=$ 
`r paste0(round(ci_betas[ci_betas$param == "b_het_normal", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_het_normal", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`
). This effect is nearly half as strong (but opposite in direction) as the dominant control on the mean probability of a high severity fire-- the vegetation density (`r fig_nums(name = "fig-effect-sizes", display = "cite")`). 

However, under extreme fuel moisture conditions, we found the opposite pattern: increasing heterogeneity of vegetation structure greatly *increased* the probability of a high severity wildfire, accounting for other variables (
$\beta_{\text{heterogeneity}}+\beta_{\text{extreme\_fm100}}+$ 
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 1), mean_fm100)), 3)` 
$*\beta_{\text{fm100}}+\beta_{\text{heterogeneity*extreme\_fm100}}+$ 
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 1), mean_fm100)), 3)` 
$*\beta_{\text{heterogeneity*fm100}}+$ 
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 1), mean_fm100)), 3)` 
$*\beta_{\text{extreme\_fm100*fm100}}+$
`r round(pull(dplyr::select(filter(fm100_s_means, extreme80_fm100 == 1), mean_fm100)), 3)` 
$*\beta_{\text{heterogeneity*extreme\_fm100*fm100}}=$ 
`r paste0(round(ci_betas[ci_betas$param == "b_het_xtreme", "mean"], 3), collapse = ", ", paste0(" (", 1:4, " pixel radius; ", apply(ci_betas[ci_betas$param == "b_het_xtreme", c("lwr", "upr")], 1, FUN = function(x) paste0("95% CI = [", paste0(as.character(round(x, 3)), collapse = ", "), "])"))))`
). The effect size of heterogeneity in extreme conditions is half to nearly two-thirds the effect size of prefire vegetation density, and in the same positive direction (`r fig_nums(name = "fig-effect-sizes", display = "cite")`).

# Discussion

We developed a new approach to calculating wildfire severity using remotely sensed images from the Landsat series of satellites using a minimal amount of user input-- a geometry (i.e., a point location or a perimeter polygon) and a fire start date. We found that the relative burn ratio (RBR) calculated using prefire Landsat images collected over a 48 day period prior to the fire and postfire Landsat images collected over a 48 day period one year after the prefire images validated the best with ground based severity measurements (composite burn index; CBI). We also found that several other remotely sensed measures of severity validated nearly as well with CBI data.

We echo the conclusion of @Zhu2006 that the validation of differences between pre- and postfire NDVI to field measured severity data, which uses near infrared reflectance, is comparable to validation using more commonly used severity metrics (e.g., RdNBR and dNBR) that rely on short wave infrared reflectance. One immediately operational implication of this is that the increasing availability of low-cost small unhumanned aerial systems (sUAS a.k.a. drones) and near infrared detecting imagers (e.g., those used for agriculture monitoring) may be used to measure wildfire severity at very high spatial resolutions.

We used our new approach to calculate wildfire severity for 920 fires that burned in the Sierra Nevada yellow pine/mixed conifer forest between 1984 and 2016. We additionally calculated 100 hour fuel moisture, local topographic roughness, potential annual heat load, prefire vegetation density, and the local heterogeneity of prefire vegetation density at 4 neighborhood sizes ranging from 0.81 hectares to 7.29 hectares. We modeled the effect of these variables on wildfire severity and found a strong positive relationship with both prefire vegetation density and potential annual heat load. We found no effect of topographic roughness on wildfire severity. We found a negative effect of 100 hour fuel moisture on severity, but only during normal fuel moisture conditions (100 hour fuel moisture greater than 20^th^ percentile). We found a strong negative effect of heterogeneity of vegetation structure on wildfire severity in normal fuel moisture conditions, and a strong positive effect of heterogeneity on severity in extreme fuel moisture conditions.

For similar vegetation density in a given local neighborhood, greater heterogeneity implies more of a mixture of dense patches and sparsely vegetated patches (see `r fig_nums(name = "fig-heterogeneity-raster", display = "cite")`). Under non-extreme fuel moisture conditions, the more sparse vegetation patches interrupt fuel continuity and reduce the likelihood of high severity fire. Under extreme fuel moisture conditions however, the more densely vegetated patches are more likely to burn at high severity and that high severity is more likley to be contagious.

Days with extreme fuel moisture conditions are likely to increase in a warming world [@Westerling2016; @Abatzoglou2016]. This could have dire consequences for the formerly self-stabilizing heterogeneous forest/infrequent high severity fire system. Densification of forests as a result of fire suppression was always a problem with respect to increases in extreme fire behavior (large fires, more high severity). Coupled with anthropogenic global warming, we may have also broken our last forest structure tool for reducing wildfire severity-- heterogeneity in structure.

### Caveats

Our method should work best in denser vegetation such as forests, as the signal of a wildfire in other systems can be invisible in a matter of weeks [@Goodwin2014]. This method would also require calibration with field data in other systems, as some severity metrics (such as RBR and RdNBR) have found limited success in other regions [@Fernandez2018].

We have captured a coarse measure of heterogeneity. While we did find that this coarse measure does strongly relate to fire severity, it does not account for fire behavior or spatial pattern forming processes at the individual tree scale. This may still be possible using remotely sensed data at a finer spatial resolution, but with a cost in temporal resolution and time series depth (e.g. NAIP imagery at 1m resolution but with only 3 total images starting in 2008) [@Dickinson2016]. Additional metrics of heterogeneity such as vegetation patch size distributions or non-vegetated gap size distributions [@Malone2018], may also be more tractable using the finer spatial resolution of NAIP imagery. 

### Translating resistance to long term persistance

Texture analysis has been used to measure habitat heterogeneity in ecology, but has only recently gained recognition for its potential to quantify system resilience [@Kefi2014]. For instance, increases in the second angular momentum of the configuration of vegetation patches may represent early warning signs of a catastrophic shift in a system whereby it converts to a vegetation-less desert. The change in this particular texture serves as an indicator of system precariousness because it reflects the spatial process by which the system stabilizes. In the case of desertification as a result of increasing grazing pressure, facilitation is the process driving vegetation patch configurations and the increase in spatial variation of those configurations indicates a breakdown in the process itself as the system moves nearer to a bifurcation point between a vegetated and a non-vegetated state. In our case, we measure heterogeneity as a spatial feature that is part of the feedback loop between disturbance and forest spatial structure, so we gain insight into longer-term patterns by measuring a signature of the pattern forming process itself. More work is needed to verify the degree to which the spatial features of mixed conifer forests-- or the spatial features of the disturbances that affect them-- capture the 

# Conclusions 

We encourage researchers and managers to make their ground based severity data available with site location (including datum) and the alarm data for the fire the field data is measuring. Cloud-based GIS, central image hosting, and integration with powerful classification tools are sure to advance our ability to measure wildfire severity remotely, automatically, consistently, and at broad spatial scales. While our contribution here demonstrates that satisfactory validation with ground based measurements is possible using simple and well known calculations, we believe that truly groundbreaking abilities to classify wildfire severity would be possible with more open data sharing of ground based severity measures.

While the severity of a wildfire in any given place may be idiosyncratic and controlled by many variables, it is clear that heterogeneous forest structure generally makes mixed conifer forest in the Sierra Nevada more resistant to this inevitable disturbance under normal fuel moisture conditions. Because a resistant forest is a resilient forest, heterogeneity in forest structure may increase the probability of long-term forest persistence. Given the opposite effect of heterogeneity in extreme fuel moisture conditions and the normalization of what were once considered extreme fuel moisture conditions in a warming world, 
